# 思维导图工具栏功能说明

## 概述
为思维导图生成器添加了完整的工具栏功能，提供放大、缩小、适应窗口、递归展开、下载等操作。

## 功能列表

### 1. 放大 (Zoom In)
- **图标**: ➕
- **功能**: 将思维导图放大1.25倍
- **快捷操作**: 点击工具栏中的放大按钮

### 2. 缩小 (Zoom Out)  
- **图标**: ➖
- **功能**: 将思维导图缩小到0.8倍
- **快捷操作**: 点击工具栏中的缩小按钮

### 3. 适应窗口 (Fit Window)
- **图标**: ⛶
- **功能**: 自动调整思维导图大小以适应容器窗口，并居中显示
- **快捷操作**: 点击工具栏中的适应窗口按钮

### 4. 递归展开 (Toggle Recursively)
- **图标**: ⧉
- **功能**: 切换递归展开/收缩模式
- **状态**: 激活时按钮高亮，点击节点会递归展开/收缩所有子节点
- **快捷操作**: 点击工具栏中的递归按钮

### 5. SVG下载 (Download SVG)
- **图标**: ⬇️
- **功能**: 将思维导图导出为SVG矢量格式
- **文件名**: `mindmap.svg`
- **优点**: 矢量格式，可无限放大，文件小

### 6. PNG下载 (Download PNG)
- **图标**: ⬇️
- **功能**: 将思维导图导出为PNG位图格式
- **文件名**: `mindmap.png`
- **特性**: 
  - 高分辨率输出（2倍分辨率）
  - 白色背景
  - 适合打印和分享

## PNG下载技术说明

### 已知问题
由于浏览器安全限制，PNG下载可能遇到"Canvas污染"问题：
```
SecurityError: Failed to execute 'toBlob' on 'HTMLCanvasElement': Tainted canvases may not be exported.
```

### 解决方案
1. **主要方案**: 使用Data URL方式避免Canvas污染
2. **备用方案**: 当PNG转换失败时，自动下载带白色背景的SVG文件
3. **用户提示**: 提供友好的错误提示和替代方案

### 技术实现
```javascript
// 使用Data URL避免跨域问题
const svgDataURL = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
img.crossOrigin = 'anonymous';
img.src = svgDataURL;
```

## 工具栏样式

### 外观设计
- **位置**: 固定在思维导图容器右上角
- **背景**: 半透明白色背景 + 毛玻璃效果
- **阴影**: 柔和的投影效果
- **圆角**: 0.5rem圆角边框
- **动画**: 悬停时有轻微上移和阴影加深效果

### 响应式设计
- 工具栏会根据容器大小自动调整位置
- 按钮图标使用SVG，支持高分辨率显示
- 悬停效果提供良好的用户反馈

## 文件结构

### 核心文件
- `content.js` - 主要内容脚本，负责加载库和创建容器
- `js/page_renderer.js` - 页面渲染脚本，包含工具栏创建逻辑
- `js/markmap-toolbar.js` - 工具栏库文件

### 测试文件
- `test-markmap.html` - 基本工具栏功能测试
- `test-png-download.html` - PNG下载功能详细测试
- `simple-png-download.html` - 简化版PNG下载测试

## 使用方法

### 在扩展中使用
1. 右键选择网页内容
2. 选择"生成思维导图"
3. 思维导图生成后，工具栏会自动出现在右上角
4. 点击相应按钮使用各种功能

### 测试功能
1. 打开任一测试HTML文件
2. 查看工具栏是否正确显示
3. 测试各个按钮功能
4. 检查控制台输出以调试问题

## 技术细节

### 库依赖顺序
```javascript
1. d3.js - D3图形库
2. markmap-lib.js - Markmap核心库  
3. markmap-view.js - Markmap视图库
4. markmap-toolbar.js - 工具栏库
```

### 工具栏创建流程
```javascript
1. 创建Markmap实例
2. 调用createToolbar()函数
3. 注册自定义下载按钮
4. 设置工具栏样式和位置
5. 绑定事件处理器
```

### 下载功能实现
- **SVG下载**: 直接序列化SVG元素
- **PNG下载**: SVG → Canvas → PNG转换
- **错误处理**: 多层备用方案确保功能可用

## 故障排除

### PNG下载失败
1. 检查浏览器控制台错误信息
2. 尝试使用SVG下载作为替代
3. 使用测试页面验证功能
4. 确认没有跨域资源加载问题

### 工具栏不显示
1. 确认所有库文件正确加载
2. 检查容器元素是否存在
3. 验证Markmap实例是否创建成功
4. 查看控制台是否有JavaScript错误

### 样式问题
1. 确认CSS样式正确注入
2. 检查容器定位设置
3. 验证z-index层级设置
4. 测试不同浏览器兼容性

## 更新日志

### v1.2 (当前版本)
- ✅ 修复PNG下载Canvas污染问题
- ✅ 添加Data URL转换方法
- ✅ 实现多层备用方案
- ✅ 改进错误处理和用户提示
- ✅ 创建专门的测试页面

### v1.1
- ✅ 添加PNG下载功能
- ✅ 实现高分辨率输出
- ✅ 添加白色背景支持

### v1.0
- ✅ 基本工具栏功能
- ✅ 放大、缩小、适应窗口
- ✅ 递归展开功能
- ✅ SVG下载功能
- ✅ 现代化UI设计 